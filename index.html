<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>⚡ Generator Controller Dashboard ⚡</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      text-align: center;
      padding: 20px;
    }
    h1 {
      color: #58a6ff;
    }
    .status {
      margin: 10px 0;
      font-size: 18px;
    }
    .voltage {
      font-size: 24px;
      margin: 20px 0;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      margin: 10px;
      cursor: pointer;
      background: #238636;
      color: white;
      transition: 0.2s;
    }
    button.off {
      background: #da3633;
    }
    button:hover {
      opacity: 0.8;
    }
    #log {
      margin-top: 30px;
      padding: 10px;
      background: #161b22;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
      font-size: 14px;
      height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>⚡ Generator Controller Dashboard ⚡</h1>
  <div class="status" id="status">🔴 Connecting...</div>
  <div class="voltage" id="voltage">Voltage: --.- V</div>
  
  <button onclick="sendCommand('ON')">Turn Generator ON</button>
  <button class="off" onclick="sendCommand('OFF')">Turn Generator OFF</button>

  <div id="log"></div>

  <script>
    // HiveMQ Cloud broker config
    const brokerUrl = "wss://49aed91892f94fffb69fc1d2d686b60f.s1.eu.hivemq.cloud:8884/mqtt";

    const options = {
      username: "ZYESP32.1",
      password: "Bmxijosh.1",
      protocol: "wss",
      clientId: "web_" + Math.random().toString(16).substr(2, 8),
      clean: true,
    };

    const client = mqtt.connect(brokerUrl, options);

    const statusEl = document.getElementById("status");
    const voltageEl = document.getElementById("voltage");
    const logEl = document.getElementById("log");

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML = `[${time}] ${msg}<br>` + logEl.innerHTML;
    }

    client.on("connect", () => {
      statusEl.textContent = "🟢 Connected to HiveMQ Cloud";
      log("Connected ✅");

      // Subscribe to voltage topic
      client.subscribe("esp32/generator/voltage", (err) => {
        if (!err) log("Subscribed to esp32/generator/voltage");
      });
    });

    client.on("error", (err) => {
      statusEl.textContent = "🔴 Connection Error: " + err.message;
      log("Error ❌ " + err.message);
    });

    client.on("message", (topic, message) => {
      if (topic === "esp32/generator/voltage") {
        try {
          const data = JSON.parse(message.toString());
          voltageEl.textContent = `Voltage: ${data.voltage.toFixed(2)} V`;
          log("Voltage update: " + data.voltage.toFixed(2) + " V");
        } catch (e) {
          log("Invalid message: " + message.toString());
        }
      }
    });

    function sendCommand(cmd) {
      client.publish("esp32/generator/control", cmd);
      log("Sent command: " + cmd);
    }
  </script>
</body>
</html>

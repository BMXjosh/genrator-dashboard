<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMARONICS Minimal Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body { font-family:sans-serif; background:#071025; color:#dbeef6; padding:20px; }
  .card { background:#0b1726; padding:15px; border-radius:10px; margin-bottom:12px; }
  .label { color:#9fb3c8; font-size:13px; }
  .value { font-weight:700; font-size:18px; }
  .status-on { color:#3bd671; }
  .status-off { color:#ff5c5c; }
</style>
</head>
<body>

<h2>AMARONICS Minimal Dashboard</h2>

<div class="card">
  <div class="label">Connection Status:</div>
  <div class="value" id="conn">Disconnected</div>
</div>

<div class="card">
  <div class="label">Generator State:</div>
  <div class="value" id="gen">--</div>
</div>

<div class="card">
  <div class="label">Lowest Voltage:</div>
  <div class="value" id="lowest">--.- V</div>
</div>

<div class="card">
  <div class="label">Voltages:</div>
  <div class="value" id="v1">V1: --.- V</div>
  <div class="value" id="v2">V2: --.- V</div>
  <div class="value" id="v3">V3: --.- V</div>
  <div class="value" id="v4">V4: --.- V</div>
</div>

<script>
const BROKER = "wss://49aed91892f94fffb69fc1d2d686b60f.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_USER = "ZYESP32.1";
const MQTT_PASS = "Bmxijosh.1";
const TELEMETRY_TOPIC = "devices/GEN-01/telemetry";

const connEl = document.getElementById('conn');
const genEl = document.getElementById('gen');
const lowestEl = document.getElementById('lowest');
const vEls = [document.getElementById('v1'), document.getElementById('v2'), document.getElementById('v3'), document.getElementById('v4')];

let lastVoltages = [null,null,null,null];
let genOn = false;

const client = mqtt.connect(BROKER, {
  username: MQTT_USER,
  password: MQTT_PASS,
  clientId: 'web-gen-' + Math.random().toString(16).slice(2,9),
  protocol: 'wss'
});

client.on('connect', () => {
  connEl.textContent = "Connected ✅";
  client.subscribe(TELEMETRY_TOPIC, (err) => {
    if(err) console.error(err);
    else console.log("Subscribed to telemetry");
  });
});

client.on('reconnect', ()=>{ connEl.textContent = "Reconnecting..."; });
client.on('error', (err)=>{ connEl.textContent = "Error"; console.error(err); });
client.on('close', ()=>{ connEl.textContent = "Disconnected"; });

client.on('message', (topic, payload) => {
  try {
    const data = JSON.parse(payload.toString());
    const keys = ['V1','V2','V3','V4'];
    let lowest = Infinity;
    for(let i=0;i<4;i++){
      const k = keys[i];
      let val = data[k] ?? data[k.toLowerCase()] ?? null;
      val = val != null ? parseFloat(val) : null;
      lastVoltages[i] = val;
      if(val != null) lowest = Math.min(lowest, val);
      vEls[i].textContent = `V${i+1}: ${val != null ? val.toFixed(2)+' V' : '--.- V'}`;
    }
    lowestEl.textContent = (lowest !== Infinity ? lowest.toFixed(2)+' V' : '--.- V');

    // gen state
    const g = data.genState ?? data.gen ?? null;
    if(g != null){
      genOn = (g.toString().toUpperCase() === 'ON' || g==='1');
      genEl.textContent = genOn ? "ON ✅" : "OFF ❌";
      genEl.className = genOn ? 'value status-on' : 'value status-off';
    }

    console.log("Telemetry:", data);
  } catch(e){
    console.error("Invalid JSON:", payload.toString());
  }
});
</script>

</body>
</html>

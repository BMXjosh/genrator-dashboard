<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AMARONICS Live Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body{font-family:sans-serif;background:#071025;color:#dbeef6;padding:20px;}
  h1{color:#00e0ff;}
  .card{background:#0b1726;padding:15px;margin:10px 0;border-radius:10px;}
  .status-on{color:#3bd671;} .status-off{color:#ff5c5c;}
</style>
</head>
<body>
<h1>AMARONICS Generator Dashboard</h1>

<div class="card">
  <strong>Connection:</strong> <span id="conn">Disconnected</span><br>
  <strong>Broker:</strong> <span id="broker"></span>
</div>

<div class="card">
  <strong>Generator:</strong> <span id="gen">--</span><br>
  <strong>Lowest Voltage:</strong> <span id="lowest">--.- V</span>
</div>

<div class="card">
  <strong>Voltages:</strong>
  <ul>
    <li>V1: <span id="v1">--.-</span> V</li>
    <li>V2: <span id="v2">--.-</span> V</li>
    <li>V3: <span id="v3">--.-</span> V</li>
    <li>V4: <span id="v4">--.-</span> V</li>
  </ul>
</div>

<script>
const BROKER = "wss://49aed91892f94fffb69fc1d2d686b60f.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_USER = "ZYESP32.1";
const MQTT_PASS = "Bmxijosh.1";
const TELEMETRY_TOPIC = "devices/GEN-01/telemetry";

document.getElementById('broker').textContent = BROKER;

const client = mqtt.connect(BROKER, {
  username: MQTT_USER,
  password: MQTT_PASS,
  clientId: 'web-gen-' + Math.random().toString(16).slice(2, 8),
  protocol: 'wss',
  clean: true,
  reconnectPeriod: 3000
});

client.on('connect', () => {
  document.getElementById('conn').textContent = 'Connected ✅';
  console.log('MQTT connected');
  client.subscribe(TELEMETRY_TOPIC, {qos:0}, (err)=>{
    if(err) console.error('Subscribe error', err);
    else console.log('Subscribed to telemetry');
  });
});

client.on('error', (err)=>{
  console.error('MQTT Error:', err.message);
  document.getElementById('conn').textContent = 'Error ❌';
});

client.on('message', (topic, message)=>{
  try {
    const data = JSON.parse(message.toString());
    ['V1','V2','V3','V4'].forEach((k,i)=>{
      const val = data[k] ?? data[k.toLowerCase()];
      document.getElementById('v'+(i+1)).textContent = val != null ? val.toFixed(2) : '--.-';
    });
    // lowest voltage
    const voltages = ['V1','V2','V3','V4'].map(k=>data[k] ?? data[k.toLowerCase()]).filter(v=>v!=null);
    const lowest = voltages.length ? Math.min(...voltages) : null;
    document.getElementById('lowest').textContent = lowest != null ? lowest.toFixed(2)+' V' : '--.- V';

    // generator state
    const gen = data.genState ?? data.gen ?? '--';
    const el = document.getElementById('gen');
    if(gen==='1' || gen?.toString().toUpperCase()==='ON'){ el.textContent='ON'; el.className='status-on'; }
    else { el.textContent='OFF'; el.className='status-off'; }
  } catch(e){
    console.error('Telemetry parse error', e);
  }
});
</script>
</body>
</html>
